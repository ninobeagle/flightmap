<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8"/>
  <title>Customer Map</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html, body, #map { height:100%; margin:0; }
    .stats { position:absolute; top:10px; right:10px; z-index:1000; background:#fff; padding:8px 12px; border-radius:6px; box-shadow:0 2px 6px rgba(0,0,0,.15); font:14px/1.3 system-ui,sans-serif; }
    .stats b { display:inline-block; width:120px; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="stats" id="statsBox">Loading…</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    // ---- SET THIS TO YOUR APPS SCRIPT WEB APP (ends with /exec) ----
    const DATA_BASE_URL = "https://script.google.com/macros/s/AKfycbyTl1sO8pLctAGRT7mQ-22j3UVka0AbQIf_GJ1QtAHUgJY2BUUSdT_GQR-xEgfAXqTj/exec";

    // Read ?customer= from the page URL
    const params = new URLSearchParams(location.search);
    const CUSTOMER = (params.get('customer') || '').trim();

    // Build base data URL (optional customer filter)
    const DATA_URL = CUSTOMER
      ? `${DATA_BASE_URL}?customer=${encodeURIComponent(CUSTOMER)}`
      : DATA_BASE_URL;

    // ---------- JSONP loader (avoids CORS) ----------
    function loadJSONP(url, callbackName, handler) {
      window[callbackName] = function (data) {
        try { handler(data); }
        finally {
          delete window[callbackName];
          if (script.parentNode) script.parentNode.removeChild(script);
        }
      };
      const script = document.createElement('script');
      const sep = url.includes('?') ? '&' : '?';
      script.src = `${url}${sep}callback=${encodeURIComponent(callbackName)}&t=${Date.now()}`;
      script.onerror = function () {
        console.error('JSONP load error for', script.src);
        document.getElementById('statsBox').textContent = 'Error loading data';
      };
      document.body.appendChild(script);
    }

    // ---------- Leaflet map ----------
    const map = L.map('map').setView([51.3, 10.2], 6);
    L.tileLayer('https://tile.openstreetmap.org/{z}/{x}/{y}.png', {
      maxZoom: 18, attribution: '&copy; OpenStreetMap contributors'
    }).addTo(map);

    function styleFeature(f) {
      const p = f.properties || {};
      const color = p.color || '#1f77b4';
      if (p.type === 'grid') return { color, weight: 2, opacity: 0.35 };
      if (p.type === 'route' && p.status === 'complete') return { color, weight: 3, opacity: 1 };
      if (p.type === 'route' && p.status === 'incomplete') return { color: '#ff7f0e', weight: 3, opacity: 1 };
      return { color: '#999', weight: 2, opacity: 0.6 };
    }

    function onEachFeature(f, layer) {
      const p = f.properties || {};
      layer.bindPopup(
        `<b>${p.filename || 'Feature'}</b><br>` +
        `<b>Type:</b> ${p.type || '–'}<br>` +
        (p.type === 'route' ? `<b>Status:</b> ${p.status || '–'}<br>` : '') +
        (p.type === 'route' && p.dist_km ? `<b>Distance:</b> ${p.dist_km} km<br>` : '') +
        `<b>Customer:</b> ${p.customer || '–'}`
      );
    }

    // ---------- Load data via JSONP ----------
    loadJSONP(DATA_URL, 'onData', function (geojson) {
      const layer = L.geoJSON(geojson, { style: styleFeature, onEachFeature }).addTo(map);
      if (layer.getLayers().length > 0) {
        map.fitBounds(layer.getBounds(), { padding: [20, 20] });
      }
      const s = geojson.stats || {};
      document.getElementById('statsBox').innerHTML =
        `<div><b>Grid total:</b> ${s.grid_km || 0} km</div>` +
        `<div><b>Flown:</b> ${s.flown_km || 0} km</div>` +
        `<div><b>To fly:</b> ${s.remaining_km || 0} km</div>` +
        `<div><b>Planned:</b> ${s.planned_km || 0} km</div>`;
    });

    // NOTE: we intentionally do NOT use fetch() here (CORS).
  </script>
</body>
</html>
